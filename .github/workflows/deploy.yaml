name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.23.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build:packages

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.BACKEND_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NODE_ENV=production

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deployment_temp
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
          cp docker-compose.yml deployment_temp/
          cp Caddyfile deployment_temp/
          cp prometheus.yml deployment_temp/
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
          cat > deployment_temp/.env << 'EOF'
          # Database
          POSTGRES_USER='${{ secrets.POSTGRES_USER }}'
          POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}'
          POSTGRES_DB='${{ secrets.POSTGRES_DB }}'
          DATABASE_URL='postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public'
          
          # Backend
          ACCESS_TOKEN_SECRET='${{ secrets.ACCESS_TOKEN_SECRET }}'
          REFRESH_TOKEN_SECRET='${{ secrets.REFRESH_TOKEN_SECRET }}'
          CLIENT_URL='${{ secrets.CLIENT_URL }}'
          UPLOAD_LOCATION='${{ secrets.UPLOAD_LOCATION }}'
          
          # Frontend
          NEXT_PUBLIC_API_URL='${{ secrets.API_URL }}'
          NEXT_PUBLIC_BACKEND_URL='${{ secrets.BACKEND_URL }}'
          NEXTAUTH_URL='${{ secrets.NEXTAUTH_URL }}'
          NEXTAUTH_SECRET='${{ secrets.NEXTAUTH_SECRET }}'
          
          # Docker
          DOMAIN_NAME='${{ secrets.DOMAIN_NAME }}'
          BACKEND_PORT='${{ secrets.BACKEND_PORT }}'
          FRONTEND_PORT='${{ secrets.FRONTEND_PORT }}'
          
          # Monitoring
          ADMIN_USER='${{ secrets.ADMIN_USER }}'
          ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}'
          MONITOR_USER='${{ secrets.MONITOR_USER }}'
          MONITOR_PASSWORD='${{ secrets.MONITOR_PASSWORD }}'
          GF_USER='${{ secrets.GF_USER }}'
          GF_PASSWORD='${{ secrets.GF_PASSWORD }}'
          EOF
          
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          cat > deployment_temp/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
          echo "üìñ Loading environment variables..."
          if [ -f .env ]; then
              set -a
              source .env
              set +a
              echo "‚úÖ Environment variables loaded"
          else
              echo "‚ùå .env file not found!"
              exit 1
          fi
          
          # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          mkdir -p /opt/workify/{postgres-data,uploads}
          chmod 755 /opt/workify /opt/workify/*
          
          # Pull latest images
          echo "üì• Pulling latest images..."
          docker compose pull
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL
          echo "üêò Starting PostgreSQL..."
          docker compose up -d postgres
          
          # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL
          echo "‚è≥ Waiting for PostgreSQL to be healthy..."
          for i in {1..30}; do
              if docker compose ps postgres | grep -q "(healthy)"; then
                  echo "‚úÖ PostgreSQL is ready and healthy!"
                  break
              fi
              echo "‚è≥ Waiting... ($i/30)"
              sleep 2
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "üîç Testing database connection with app user..."
          if docker compose exec -T postgres psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 1;" > /dev/null 2>&1; then
              echo "‚úÖ Database user can connect successfully"
          else
              echo "‚ö†Ô∏è  User cannot connect, attempting to fix permissions..."
              
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º superuser –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤
              docker compose exec -T postgres psql -U postgres <<EOF
              DO \$\$
              BEGIN
                  -- –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$POSTGRES_USER') THEN
                      CREATE USER "$POSTGRES_USER" WITH PASSWORD '$POSTGRES_PASSWORD';
                      RAISE NOTICE 'User $POSTGRES_USER created';
                  ELSE
                      -- –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                      ALTER USER "$POSTGRES_USER" WITH PASSWORD '$POSTGRES_PASSWORD';
                  END IF;
                  
                  -- –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '$POSTGRES_DB') THEN
                      CREATE DATABASE "$POSTGRES_DB" OWNER "$POSTGRES_USER";
                      RAISE NOTICE 'Database $POSTGRES_DB created';
                  END IF;
                  
                  -- –î–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                  GRANT ALL PRIVILEGES ON DATABASE "$POSTGRES_DB" TO "$POSTGRES_USER";
                  
                  -- –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –∏ –¥–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å—Ö–µ–º—É public
                  \c "$POSTGRES_DB";
                  GRANT ALL ON SCHEMA public TO "$POSTGRES_USER";
                  GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "$POSTGRES_USER";
                  GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "$POSTGRES_USER";
                  ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "$POSTGRES_USER";
                  ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "$POSTGRES_USER";
              END
              \$\$;
          EOF
              echo "‚úÖ Database permissions fixed"
          fi
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∏–¥—ã
          echo "üîÑ Running database setup..."
          
          echo "üöÄ Starting backend for migrations..."
          docker compose up -d backend
          sleep 10  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend
          
          echo "üì¶ Running Prisma migrations..."
          docker compose exec backend sh -c "
              echo 'Current directory: \$(pwd)'
              echo 'DATABASE_URL environment variable:'
              echo \$DATABASE_URL | sed 's/:[^:@]*@/:****@/'
              
              echo 'Changing to database package...'
              cd /app/packages/database
              
              echo 'Running migrations and seeds...'
              pnpm run db:setup
              
              echo '‚úÖ Database setup completed inside container'
          "
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
          echo "üîß Starting all services..."
          docker compose up -d --remove-orphans
          
          # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
          echo "‚è≥ Waiting for services to start..."
          sleep 20
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
          echo "üè• Checking services health..."
          docker compose ps
          
          # –û—á–∏—Å—Ç–∫–∞
          echo "üßπ Cleaning up old images..."
          docker image prune -f
          
          echo "‚úÖ Deployment completed successfully!"
          echo ""
          echo "üåê Frontend: https://${DOMAIN_NAME}"
          echo "üîß API: https://api.${DOMAIN_NAME}"
          echo "üõ†Ô∏è Adminer: https://admin.${DOMAIN_NAME}"
          EOF
          
          chmod +x deployment_temp/deploy.sh
          tar -czf deployment-package.tar.gz -C deployment_temp .

      - name: Copy deployment package to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "deployment-package.tar.gz"
          target: "/tmp/"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -e
            echo "üöÄ Starting deployment on server..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            sudo mkdir -p /opt/workify
            sudo chown ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /opt/workify
            cd /opt/workify
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
            echo "üõë Stopping existing services..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞–∫–µ—Ç –¥–µ–ø–ª–æ—è
            echo "üì¶ Extracting deployment package..."
            tar -xzf /tmp/deployment-package.tar.gz -C . --strip-components=1
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π
            echo "üéØ Running deployment script..."
            ./deploy.sh
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            echo "üîç Verifying deployment..."
            sleep 10
            
            echo "üéâ Deployment completed successfully!"