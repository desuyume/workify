name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.23.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build:packages

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.BACKEND_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NODE_ENV=production

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deployment_temp

          # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.yml (—É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å environment –±–ª–æ–∫–∞–º–∏)
          cp docker-compose.yml deployment_temp/
          cp Caddyfile deployment_temp/
          cp prometheus.yml deployment_temp/

          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
          cat > deployment_temp/.env << 'EOF'
          NODE_ENV=production

          # Database
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public

          # Backend
          ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          CLIENT_URL=${{ secrets.CLIENT_URL }}

          # Frontend
          NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}
          NEXT_PUBLIC_BACKEND_URL=${{ secrets.BACKEND_URL }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

          # S3
          S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}
          S3_ACCESS_KEY_ID=${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY=${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_REGION=${{ secrets.S3_REGION }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          S3_SUBDOMAIN=${{ secrets.S3_SUBDOMAIN }}

          # Docker
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          BACKEND_PORT=${{ secrets.BACKEND_PORT }}
          FRONTEND_PORT=${{ secrets.FRONTEND_PORT }}

          # Monitoring
          ADMIN_USER=${{ secrets.ADMIN_USER }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          MONITOR_USER=${{ secrets.MONITOR_USER }}
          MONITOR_PASSWORD=${{ secrets.MONITOR_PASSWORD }}
          GF_USER=${{ secrets.GF_USER }}
          GF_PASSWORD=${{ secrets.GF_PASSWORD }}

          EOF

          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          cat > deployment_temp/deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "üöÄ Starting deployment..."

          # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if [ -f .env ]; then
            set -a
            source .env
            set +a
            echo "‚úÖ Environment variables loaded"
          else
            echo "‚ùå .env file not found!"
            exit 1
          fi

          # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          sudo mkdir -p /opt/workify/{postgres-data}
          sudo chown $USER:$USER /opt/workify /opt/workify/*
          chmod 755 /opt/workify /opt/workify/*

          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
          echo "üõë Stopping existing services..."
          docker compose down --remove-orphans 2>/dev/null || true

          # Pull latest images
          echo "üì• Pulling latest images..."
          docker compose pull

          echo "üêò Starting PostgreSQL..."
          docker compose up -d postgres

          echo "‚è≥ Waiting for PostgreSQL..."
          for i in {1..30}; do
            if docker compose exec postgres pg_isready -U "$POSTGRES_USER" >/dev/null 2>&1; then
              echo "‚úÖ PostgreSQL is ready!"
              break
            fi
            echo "‚è≥ Waiting... ($i/30)"
            sleep 2
          done

          echo "üë§ Checking database user..."
          docker compose exec postgres psql -U postgres -c "
          DO \$\$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$POSTGRES_USER') THEN
              CREATE USER \"$POSTGRES_USER\" WITH PASSWORD '$POSTGRES_PASSWORD';
              RAISE NOTICE 'User $POSTGRES_USER created';
            END IF;

            IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '$POSTGRES_DB') THEN
              CREATE DATABASE \"$POSTGRES_DB\" OWNER \"$POSTGRES_USER\";
              RAISE NOTICE 'Database $POSTGRES_DB created';
            END IF;

            -- –î–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∞
            GRANT ALL PRIVILEGES ON DATABASE \"$POSTGRES_DB\" TO \"$POSTGRES_USER\";
          END
          \$\$;" 2>/dev/null || echo "User/database check completed"

          echo "üîÑ Running database setup..."

          echo "üöÄ Starting backend container..."
          docker compose up -d backend
          sleep 10  # –ñ–¥–µ–º –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ backend

          echo "üì¶ Running Prisma migrations..."
          docker compose exec backend sh -c "
            cd /app/packages/database
            pnpm run db:setup
            echo '‚úÖ Database setup completed!'
          "

          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üîÑ Restarting backend..."
          docker compose restart backend

          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
          echo "üîß Starting all services..."
          docker compose up -d --remove-orphans

          # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
          echo "‚è≥ Waiting for services to start..."
          sleep 20

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
          echo "üè• Checking services health..."
          docker compose ps

          # –û—á–∏—Å—Ç–∫–∞
          echo "üßπ Cleaning up old images..."
          docker image prune -f

          EOF

          chmod +x deployment_temp/deploy.sh

          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
          tar -czf deployment-package.tar.gz -C deployment_temp .

      - name: Copy deployment package to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: 'deployment-package.tar.gz'
          target: '/tmp/'

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -e
            echo "üöÄ Starting deployment on server..."

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            cd /opt/workify

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞–∫–µ—Ç –¥–µ–ø–ª–æ—è
            echo "üì¶ Extracting deployment package..."
            tar -xzf /tmp/deployment-package.tar.gz -C . --overwrite

            # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π
            echo "üéØ Running deployment script..."
            chmod +x deploy.sh
            ./deploy.sh

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            echo "üîç Verifying deployment..."
            sleep 15

            echo "üéâ Deployment completed successfully!"
