name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.23.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build:packages

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.BACKEND_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NODE_ENV=production

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deployment_temp
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          cp docker-compose.yml deployment_temp/
          cp Caddyfile deployment_temp/
          cp prometheus.yml deployment_temp/
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°
          cat > deployment_temp/.env << 'EOF'
          # Database
          POSTGRES_USER='${{ secrets.POSTGRES_USER }}'
          POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}'
          POSTGRES_DB='${{ secrets.POSTGRES_DB }}'
          DATABASE_URL='postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public'
          
          # Backend
          ACCESS_TOKEN_SECRET='${{ secrets.ACCESS_TOKEN_SECRET }}'
          REFRESH_TOKEN_SECRET='${{ secrets.REFRESH_TOKEN_SECRET }}'
          CLIENT_URL='${{ secrets.CLIENT_URL }}'
          UPLOAD_LOCATION='${{ secrets.UPLOAD_LOCATION }}'
          
          # Frontend
          NEXT_PUBLIC_API_URL='${{ secrets.API_URL }}'
          NEXT_PUBLIC_BACKEND_URL='${{ secrets.BACKEND_URL }}'
          NEXTAUTH_URL='${{ secrets.NEXTAUTH_URL }}'
          NEXTAUTH_SECRET='${{ secrets.NEXTAUTH_SECRET }}'
          
          # Docker
          DOMAIN_NAME='${{ secrets.DOMAIN_NAME }}'
          BACKEND_PORT='${{ secrets.BACKEND_PORT }}'
          FRONTEND_PORT='${{ secrets.FRONTEND_PORT }}'
          
          # Monitoring
          ADMIN_USER='${{ secrets.ADMIN_USER }}'
          ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}'
          MONITOR_USER='${{ secrets.MONITOR_USER }}'
          MONITOR_PASSWORD='${{ secrets.MONITOR_PASSWORD }}'
          GF_USER='${{ secrets.GF_USER }}'
          GF_PASSWORD='${{ secrets.GF_PASSWORD }}'
          EOF
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
          cat > deployment_temp/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ Starting deployment..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          mkdir -p /opt/workify/{postgres-data,uploads}
          chmod 755 /opt/workify /opt/workify/*
          
          # Pull latest images
          echo "ğŸ“¥ Pulling latest images..."
          docker compose pull
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ PostgreSQL
          echo "ğŸ˜ Starting PostgreSQL..."
          docker compose up -d postgres
          
          # Ğ–Ğ´ĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ PostgreSQL
          echo "â³ Waiting for PostgreSQL..."
          for i in {1..30}; do
            if docker compose exec postgres pg_isready -U ${POSTGRES_USER:-postgres} >/dev/null 2>&1; then
              echo "âœ… PostgreSQL is ready!"
              break
            fi
            echo "â³ Waiting... ($i/30)"
            sleep 2
          done
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ‘Ğ” ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
          echo "ğŸ‘¤ Checking database user..."
          docker compose exec postgres psql -U postgres -c "
          DO \$\$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${POSTGRES_USER}') THEN
              CREATE USER ${POSTGRES_USER} WITH PASSWORD '${POSTGRES_PASSWORD}';
              RAISE NOTICE 'User ${POSTGRES_USER} created';
            END IF;

            IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '${POSTGRES_DB}') THEN
              CREATE DATABASE ${POSTGRES_DB} OWNER ${POSTGRES_USER};
              RAISE NOTICE 'Database ${POSTGRES_DB} created';
            END IF;

            -- Ğ”Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° ÑĞ²Ğ¾Ñ Ğ±Ğ°Ğ·Ñƒ
            GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_DB} TO ${POSTGRES_USER};
            ALTER DATABASE ${POSTGRES_DB} OWNER TO ${POSTGRES_USER};
          END
          \$\$;" 2>/dev/null || echo "User/database check completed"
          
          # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ ÑĞ¸Ğ´Ñ‹
          echo "ğŸ”„ Running database setup..."
          
          # ĞÑ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
          echo "=== DEBUG INFO ==="
          echo "POSTGRES_USER: $POSTGRES_USER"
          echo "POSTGRES_DB: $POSTGRES_DB"
          echo "DATABASE_URL from env: $DATABASE_URL"
          echo "=================="
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸
          cat > /tmp/db_vars.env << EOF
          POSTGRES_USER=$POSTGRES_USER
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          POSTGRES_DB=$POSTGRES_DB
          DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB?schema=public
          EOF
          
          echo "Testing connection to PostgreSQL..."
          docker compose exec postgres psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 1;" 2>/dev/null && echo "âœ… Connection successful" || echo "âŒ Connection failed"
          
          # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ ÑĞ²Ğ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡ĞµĞ¹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
          echo "Running migrations..."
          docker compose run --rm \
            -e "POSTGRES_USER=$POSTGRES_USER" \
            -e "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" \
            -e "POSTGRES_DB=$POSTGRES_DB" \
            -e "DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB?schema=public" \
            backend \
            sh -c "
              echo '=== Inside container ==='
              echo 'POSTGRES_USER: '\$POSTGRES_USER
              echo 'POSTGRES_DB: '\$POSTGRES_DB
              echo 'DATABASE_URL: '\$DATABASE_URL | sed 's/:[^:@]*@/:****@/'
              echo '======================='
              
              echo 'Setting up database...'
              cd /app/packages/database
              
              # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ prisma ÑÑ…ĞµĞ¼Ñƒ
              echo 'Checking Prisma schema...'
              cat prisma/schema.prisma | grep -A5 'datasource db'
              
              echo 'Running Prisma migrations and seeds...'
              pnpm run db:setup
            "
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
          echo "ğŸ”§ Starting all services..."
          docker compose up -d --remove-orphans
          
          # Ğ–Ğ´ĞµĞ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
          echo "â³ Waiting for services to start..."
          sleep 20
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
          echo "ğŸ¥ Checking services health..."
          docker compose ps
          
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          echo "âœ… Deployment completed successfully!"
          echo ""
          echo "ğŸŒ Frontend: https://${DOMAIN_NAME}"
          echo "ğŸ”§ API: https://api.${DOMAIN_NAME}"
          echo "ğŸ› ï¸ Adminer: https://admin.${DOMAIN_NAME}"
          EOF
          
          chmod +x deployment_temp/deploy.sh
          tar -czf deployment-package.tar.gz -C deployment_temp .

      - name: Copy deployment package to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "deployment-package.tar.gz"
          target: "/tmp/"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment on server..."
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
            sudo mkdir -p /opt/workify
            sudo chown ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /opt/workify
            cd /opt/workify
            
            # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
            echo "ğŸ›‘ Stopping existing services..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
            echo "ğŸ“¦ Extracting deployment package..."
            tar -xzf /tmp/deployment-package.tar.gz -C . --strip-components=1
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
            echo "ğŸ¯ Running deployment script..."
            ./deploy.sh
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
            echo "ğŸ” Verifying deployment..."
            sleep 10
            
            echo "ğŸ‰ Deployment completed successfully!"