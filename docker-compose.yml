services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./certbot/www:/var/www/certbot
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - frontend
      - backend
      - adminer
    networks:
      - workify-network
    restart: unless-stopped
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

  frontend:
    image: ghcr.io/desuyume/workify-frontend:latest
    env_file: ./.env
    networks:
      - workify-network
    restart: unless-stopped

  backend:
    image: ghcr.io/desuyume/workify-backend:latest
    env_file: ./.env
    depends_on:
      - postgres
    networks:
      - workify-network
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    env_file: ./.env
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    networks:
      - workify-network
    restart: unless-stopped

  adminer:
    image: adminer:4.8.1
    ports:
      - "8080:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DEFAULT_DB=${POSTGRES_DB}
    depends_on:
      - postgres
    networks:
      - workify-network
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    restart: unless-stopped
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: >
      /bin/sh -c '
      # –ñ–¥–µ–º –ø–æ–∫–∞ nginx –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
      sleep 10;
      
      if [ ! -f /etc/letsencrypt/live/workify-dev.ru/fullchain.pem ]; then
        echo "üîê –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...";
        certbot certonly \
          --webroot \
          -w /var/www/certbot \
          --email 77desss@gmail.com \
          --agree-tos \
          --no-eff-email \
          -d workify-dev.ru \
          -d www.workify-dev.ru \
          -d api.workify-dev.ru \
          -d admin.workify-dev.ru \
          --non-interactive;
      fi;
      
      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
      trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;
      '
    networks:
      - workify-network
    depends_on:
      - nginx

networks:
  workify-network:
    driver: bridge

volumes:
  postgres-data: